<!DOCTYPE html>
<html lang="en-us">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Averia+Serif+Libre&display=swap" rel="stylesheet"> 
	<title>WIT Resources</title>
        <meta property="og:title" content="WIT Resources" />
<meta property="og:description" content="Introduction to &#34;resources&#34; in WIT." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://kflansburg.com/posts/wit-resources/" /><meta property="og:image" content="https://kflansburg.com/profile.jpg"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-05T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-08-05T00:00:00+00:00" />

        <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://kflansburg.com/profile.jpg"/>

<meta name="twitter:title" content="WIT Resources"/>
<meta name="twitter:description" content="Introduction to &#34;resources&#34; in WIT."/>

	<meta name="description" content="Introduction to &#34;resources&#34; in WIT.">
	
	<link rel="stylesheet" href="/css/style.css">
	
	
</head>
<body>
	<header>
    <div>
    
    <a href="https://kflansburg.com/">kflansburg.com</a>
    
    
    <div style="text-align: right;">Discussions on Rust, Kubernetes, architecture, and more.</div>
    </div>
    <nav class='links'>
        
            |
            
            <a href="/posts/"><b>Posts</b></a> |
        
            <a href="/tags/"><b>Tags</b></a> |
        
            <a href="/series/"><b>Series</b></a> |
        
    </nav>
    
</header>

	
    <main>
        <article>
            
                <h1>WIT Resources</h1>
            

            
                <b><time>2023-08-05</time></b>
                <span>-- 464 Words</span>
                <br/>
                
                    <a href="/tags/rust/">Rust,</a>
                
                    <a href="/tags/wasm/">Wasm,</a>
                
            
            <div>
                
                <p>Support for &ldquo;resources&rdquo; <a href="https://github.com/bytecodealliance/wit-bindgen/commit/62f3f649e38ed4f111729595ce32ee0308ab0f7c">just landed</a>
in the <code>wit-bindgen</code> repository. This post explores why resources are crucial
for writing rich, object-oriented APIs in WIT.</p>
<p>The WIT format definition <a href="https://github.com/WebAssembly/component-model/blob/main/design/mvp/WIT.md#item-resource">describes resources</a> as an &ldquo;abstract type&hellip; which is an entity with a lifetime that can only be passed around indirectly via handle values.&rdquo; This allows host runtimes to define an interface, and then return objects
to the guest by reference (handle). These objects live in and are managed by the host, which significantly reduces the need
for copying data in and out of WASM memory.</p>
<h2 id="motivation">Motivation</h2>
<p>As an example, before resources, it was common for HTTP <code>fetch</code> calls to return either a full copy of the response, or a &ldquo;handle&rdquo; to a response object. Rather than this being a first class object, it was simply an integer handle, and the end-user was required to pass this handle
into &ldquo;instance methods&rdquo; to interact with this object:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-0-0"><a class="lnlinks" href="#hl-0-0">0</a>
</span><span class="lnt" id="hl-0-1"><a class="lnlinks" href="#hl-0-1">1</a>
</span><span class="lnt" id="hl-0-2"><a class="lnlinks" href="#hl-0-2">2</a>
</span><span class="lnt" id="hl-0-3"><a class="lnlinks" href="#hl-0-3">3</a>
</span><span class="lnt" id="hl-0-4"><a class="lnlinks" href="#hl-0-4">4</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch</span><span class="p">(</span><span class="s">&#34;https://kflansburg.com&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response_status</span><span class="p">(</span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response_body</span><span class="p">(</span><span class="n">response</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, this works fine, but is clunky, and makes raw host APIs unpleasent to interact with.
Many platforms then have to ship an &ldquo;sdk&rdquo; or other language-specific wrapper to make this more ergonomic.</p>
<h2 id="usage">Usage</h2>
<p>Now, with resources, we can do this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt" id="hl-1-0"><a class="lnlinks" href="#hl-1-0">0</a>
</span><span class="lnt" id="hl-1-1"><a class="lnlinks" href="#hl-1-1">1</a>
</span><span class="lnt" id="hl-1-2"><a class="lnlinks" href="#hl-1-2">2</a>
</span><span class="lnt" id="hl-1-3"><a class="lnlinks" href="#hl-1-3">3</a>
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fetch</span><span class="p">(</span><span class="s">&#34;https://kflansbug.com&#34;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="kd">let</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">body</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>In this case, the <code>response</code> object can be used like a first-class object, and data such as <code>body</code> is
only copied into the guest memory if it is used.</p>
<h2 id="definition">Definition</h2>
<p>On the WIT side of things, resources are defined roughly (this is untested) like:</p>
<pre tabindex="0"><code>resource response {
    constructor(body: list&lt;u8&gt;, status: u16)
    status: func(self: borrow&lt;response&gt;) -&gt; u16
    body: func(self: response) -&gt; list&lt;u8&gt;
    
    not-found: static func() -&gt; reponse
}

interface http {
    fetch: func(url: string) -&gt; response
}
</code></pre><p>There are a couple of interesting things here. First, there is a <code>constructor</code> definition, which allows the guest to create
new response objects (which are still managed by the host), and obtain a handle to them.</p>
<p>Next, the <code>status</code> method takes a <code>borrow</code> of <code>response</code>, which means that response will live beyond usage of that method. <code>body</code>, on the other hand, takes ownership of and consumes <code>response</code>, which cannot be used again.</p>
<p>Finally, <code>not-found</code> is a <code>static</code> method, which does not take a <code>self</code> parameter, but allows for related, non-instance functions to be namespaced within the resource.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Resources were a key missing piece and will signifigantly improve the ergonomics and sophistication of WASM host APIs. Specifically, APIs related to managing file descriptors, streams, or deeply nested types will be significantly easier
to develop with for both the platform and the guest. Finally, this type of pattern will be very useful for enabling
capability-based access patterns in guest components.</p>
            </div>
        </article>
        

<aside>
    <div>
        
            <div>
            <h3>LATEST POSTS</h3>
            </div>
            <div>
            <ul>
            
                <li>
                    
                    <a href="/posts/wit-resources/">
                        WIT Resources
                    </a>
                </li>
            
                <li>
                    
                    <a href="/posts/wit-and-wit-bindgen-thoughts/">
                        Thoughts on WIT and wit-bindgen
                    </a>
                </li>
            
                <li>
                    
                    <a href="/posts/merge-queues/">
                        Merge Queues with Bors
                    </a>
                </li>
            
                <li>
                    
                    <a href="/posts/rust-cachepot/">
                        Speed up Rust Builds with Cachepot
                    </a>
                </li>
            
                <li>
                    
                    <a href="/posts/introducing-krator/">
                        Krator: My God, it&#39;s Full of States!
                    </a>
                </li>
            
            </ul>
            </div>
        
    </div>
</aside>

    </main>

	<footer>
	<p>&copy; 2023 <a href="https://kflansburg.com/"><b>Kevin Flansburg</b></a> |
	<a href="https://github.com/kflansburg"><b>GitHub</b></a> |
	<a href="https://twitter.com/kevin_flansburg"><b>Twitter</b></a> |
	<a href="https://www.linkedin.com/in/kflansburg/"><b>LinkedIn</b></a> |
	</p>
</footer>

<script data-goatcounter="https://kflansburg.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
